FROM alpine:latest
LABEL maintainer="Salvatore Francesco Indino"

# Installazione dipendenze per Nebula
RUN apk update && apk upgrade && \
    apk add --no-cache bash git make cmake gcc musl-dev openssl-dev

RUN apk add --no-cache go

RUN echo http://dl-cdn.alpinelinux.org/alpine/edge/community >> /etc/apk/repositories
    
# Copia dei file di configurazione necessari a nebula
WORKDIR /nebula

COPY ./nebula /nebula/
COPY ./ca.key  /nebula/
COPY ./ca.crt /nebula/
COPY ./host.crt /nebula/
COPY ./host.key /nebula/
COPY ./config.yaml /nebula/



#RUN ifconfig



# Esposizione delle porte utilizzate da Nebula
EXPOSE 4242/tcp
EXPOSE 4242/udp

EXPOSE 4241/tcp
EXPOSE 4241/udp

EXPOSE 4243/tcp
EXPOSE 4243/udp

# Install sudo package
RUN apk add --no-cache sudo

#install ip route package
RUN apk add --no-cache nebula openrc iproute2
RUN apk update && apk add bind-tools








    
# Configurazione dell'interfaccia 


#----------------------------

#----------------------------




#CMD mkdir -p /dev/net && mknod /dev/net/tun c 10 200 && ip tuntap add dev tun0 mode tun && ip addr add 192.168.100.9/24 dev tun0 && ip link set dev tun0 up && ./nebula -config /nebula/config.yaml
#FROM alpine:latest



#CMD mkdir -p /dev/net && mknod /dev/net/tun c 10 200 && ip tuntap add dev tun0 mode tun && ip addr add 192.168.100.9/24 dev tun0 && ip link set dev tun0 up && ./nebula -config /nebula/config.yaml

WORKDIR /nebula
#CMD ls /dev/net && ip link set dev nebula1 up&& ifconfig &&./nebula -config /nebula/config.yaml
#&& mknod /dev/net/tun c 10 200 || true && ip tuntap add dev nebula1 mode tun && ip addr add 192.168.100.9/24 dev  && ip link set dev tun0 up && ./nebula -config /nebula/config.yaml

#WORKDIR /nebula

# Impostazione del comando predefinito per avviare Nebula
CMD ["./nebula", "-config", "/nebula/config.yaml"]

